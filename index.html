<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Operacional ‚Äì GPS / Cargas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f5f6f7; --card:#fff; --txt:#0f172a; --muted:#6b7280;
      --border:#e5e7eb; --ok:#16a34a; --alert:#dc2626;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    html,body{height:100%;}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);}
    .topbar{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--border);padding:10px;}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;max-width:1400px;margin:auto;}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:10px;display:flex;gap:10px;flex-wrap:wrap;}
    label{font-size:13px;color:var(--muted);display:flex;gap:6px;align-items:center;}
    input,select{padding:7px 9px;border:1px solid var(--border);border-radius:10px;}
    button{padding:9px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;}
    button:disabled{opacity:.6;}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);}
    .pill.ok{background:#eaf7ee;color:#0f5d1a;}
    .pill.alert{background:#fdecec;color:#7f1d1d;}
    #map{height:calc(100vh - 90px);}
    .legend{position:absolute;right:14px;bottom:14px;background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px;font-size:12px;}
    .lg{display:flex;align-items:center;gap:8px;margin:4px 0;}
    .dot{width:10px;height:10px;border-radius:999px;}
    .dot.hotel{background:#2563eb;}
    .dot.emb{background:#7c3aed;}
    .dot.casa{background:#0ea5e9;}
    .dot.parado{background:#f59e0b;}
    .dot.ok{background:#16a34a;}
    .dot.alert{background:#dc2626;}
  </style>
</head>

<body>

<div class="topbar">
  <div class="row">
    <div class="card">
      <label>üìÖ Data <input id="inpData" placeholder="dd/MM/aaaa"></label>

      <label>Cargas
        <select id="selCargas">
          <option value="">TODAS</option>
          <option value="OK">OK</option>
          <option value="ALERTA">ALERTA</option>
        </select>
      </label>

      <label>Ve√≠culos
        <select id="selVeiculos">
          <option value="">TODOS</option>
          <option value="OK">OK</option>
          <option value="ALERTA">ALERTA</option>
        </select>
      </label>

      <label><input type="checkbox" id="chkHoteis" checked> Hot√©is</label>
      <label><input type="checkbox" id="chkEmbarques" checked> Embarques</label>
      <label><input type="checkbox" id="chkCasas"> Casas</label>
      <label><input type="checkbox" id="chkVeiculos" checked> Ve√≠culos</label>
      <label><input type="checkbox" id="chkCargas" checked> Cargas</label>

      <button id="btnAtualizar">Atualizar</button>
      <span id="pill" class="pill">Pronto</span>
    </div>
  </div>
</div>

<div id="map"></div>

<div class="legend">
  <div class="lg"><span class="dot hotel"></span>Hotel</div>
  <div class="lg"><span class="dot emb"></span>Embarque</div>
  <div class="lg"><span class="dot casa"></span>Casa</div>
  <div class="lg"><span class="dot parado"></span>Ve√≠culo parado</div>
  <hr>
  <div class="lg"><span class="dot ok"></span>Status OK</div>
  <div class="lg"><span class="dot alert"></span>Status ALERTA</div>
</div>

<script>
const $ = id => document.getElementById(id);

const map = L.map("map").setView([-14.235, -51.925], 4);

// ===== MAPAS BASE =====
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19});
const sat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {maxZoom:19}
);
const terrain = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
  {maxZoom:19}
);
osm.addTo(map);

// ===== CAMADAS =====
const layerHoteis = L.layerGroup().addTo(map);
const layerEmbarques = L.layerGroup().addTo(map);
const layerCasas = L.layerGroup().addTo(map);
const layerVeiculos = L.layerGroup().addTo(map);
const layerCargas = L.layerGroup().addTo(map);

// ===== CONTROLE =====
L.control.layers(
  { "Mapa": osm, "Sat√©lite": sat, "Terreno": terrain },
  {
    "Hot√©is": layerHoteis,
    "Embarques": layerEmbarques,
    "Casas": layerCasas,
    "Ve√≠culos": layerVeiculos,
    "Cargas": layerCargas
  }
).addTo(map);

function iconDot(color){
  return L.divIcon({
    html:`<div style="width:12px;height:12px;border-radius:50%;background:${color};border:2px solid #fff"></div>`,
    iconSize:[12,12],
    iconAnchor:[6,6]
  });
}

function iconPin(color){
  return L.divIcon({
    html:`<svg width="26" height="38"><path d="M13 37s11-14 11-23a11 11 0 1 0-22 0c0 9 11 23 11 23z" fill="${color}" stroke="#fff" stroke-width="2"/></svg>`,
    iconSize:[26,38],
    iconAnchor:[13,37]
  });
}

// ===== DADOS =====
function atualizar(){
  $("btnAtualizar").disabled = true;
  $("pill").textContent = "Carregando‚Ä¶";

  const filtro = {
    data: $("inpData").value,
    statusCargas: $("selCargas").value,
    statusVeiculos: $("selVeiculos").value
  };

  Promise.all([
    new Promise(r=>google.script.run.withSuccessHandler(r).apiGetHoteis()),
    new Promise(r=>google.script.run.withSuccessHandler(r).apiGetPontosEmbarque()),
    new Promise(r=>google.script.run.withSuccessHandler(r).apiGetCasas()),
    new Promise(r=>google.script.run.withSuccessHandler(r).apiGetVeiculosParadosClassificados(filtro)),
    new Promise(r=>google.script.run.withSuccessHandler(r).apiGetCargasAgrupadas(filtro))
  ]).then(([h,e,c,v,ca])=>{

    layerHoteis.clearLayers();
    (h||[]).forEach(x=>L.marker([x.lat,x.lng],{icon:iconDot("#2563eb")}).bindPopup(x.nome).addTo(layerHoteis));

    layerEmbarques.clearLayers();
    (e||[]).forEach(x=>L.marker([x.lat,x.lng],{icon:iconDot("#7c3aed")}).bindPopup(x.nome).addTo(layerEmbarques));

    layerCasas.clearLayers();
    (c||[]).forEach(x=>L.marker([x.lat,x.lng],{icon:iconDot("#0ea5e9")}).bindPopup(x.nome).addTo(layerCasas));

    layerVeiculos.clearLayers();
    (v||[]).forEach(x=>{
      const cor = x.status==="ALERTA"?"#dc2626":"#16a34a";
      L.marker([x.lat,x.lng],{icon:iconPin(cor)})
        .bindPopup(`
          <b>Ve√≠culo parado (${x.status})</b><br>
          Ve√≠culo: ${x.veiculo}<br>
          Motorista: ${x.motorista}<br>
          Parado: ${x.parado_horas} h<br>
          Hora: ${x.DataHora_anterior} ‚Üí ${x.DataHora_atual}
        `)
        .addTo(layerVeiculos);
    });

    layerCargas.clearLayers();
    (ca||[]).forEach(x=>{
      const cor = x.status==="ALERTA"?"#dc2626":"#16a34a";
      L.marker([x.lat,x.lng],{icon:iconDot(cor)})
        .bindPopup(`<b>Carga (${x.status})</b><br>${x.classificador}<br>${x.tons} t`)
        .addTo(layerCargas);
    });

    $("pill").textContent = "OK";
    $("pill").className = "pill ok";
    $("btnAtualizar").disabled = false;
  });
}

$("btnAtualizar").onclick = atualizar;
atualizar();
</script>

</body>
</html>
