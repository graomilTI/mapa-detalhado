<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mapa Operacional â€“ GPS / Cargas</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster (opcional, mas ajuda MUITO em cargas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#f5f6f7;
      --card:#ffffff;
      --border:#e6e8eb;
      --text:#1f2937;
      --muted:#6b7280;
      --radius:14px;
      --shadow:0 8px 22px rgba(0,0,0,.08);
      --shadow2:0 1px 3px rgba(0,0,0,.08);
      --blue:#2563eb;
      --green:#16a34a;
      --red:#ef4444;
      --orange:#f59e0b;
      --teal:#14b8a6;
      --purple:#8b5cf6;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 2000;
      background: var(--bg);
      padding: 10px 10px 8px;
      border-bottom: 1px solid var(--border);
    }
    .controls{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 10px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
    }
    .group{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 4px 6px;
      border-radius: 12px;
    }
    .label{
      color:var(--muted);
      font-size: 12px;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:6px;
    }
    input[type="date"], select{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
      background:#fff;
      outline:none;
      font-size: 13px;
      height: 36px;
    }
    .btn{
      border:none;
      border-radius: 12px;
      padding: 9px 14px;
      height: 36px;
      cursor:pointer;
      font-weight: 700;
      background: var(--blue);
      color:#fff;
    }
    .pill{
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background:#fff;
      font-size: 12px;
      color: var(--muted);
    }
    .okpill{ color: var(--green); font-weight:700; }
    .badpill{ color: var(--red); font-weight:700; }
    .warnpill{ color: var(--orange); font-weight:700; }

    .toggles{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      margin-left: 6px;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:6px;
      font-size: 13px;
      color: var(--text);
      user-select:none;
    }

    /* Map area */
    #mapWrap{
      position: relative;
      height: calc(100vh - 78px);
      width: 100vw;
    }
    #map{
      height:100%;
      width:100%;
    }

    /* Legenda flutuante */
    #legend-container{
      position:absolute;
      top: 10px;
      right: 10px;
      z-index: 1500;
      background: rgba(255,255,255,0.96);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      box-shadow: var(--shadow);
      width: 220px;
      max-width: calc(100vw - 20px);
      font-size: 12px;
    }
    .legend-title{
      font-weight: 800;
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:8px;
    }
    .legend-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin: 6px 0;
      color: var(--text);
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display:inline-block;
      border: 1px solid rgba(0,0,0,.15);
    }
    .dot.casa{ background: var(--purple); }
    .dot.hotel{ background: var(--teal); }
    .dot.emb{ background: #111827; }
    .dot.veic{ background: var(--orange); }
    .dot.carga{ background: var(--blue); }
    .dot.ok{ background: var(--green); }
    .dot.alert{ background: var(--red); }

    .legend-small{
      color: var(--muted);
      font-size: 11px;
      margin-top: 8px;
      line-height: 1.25;
    }

    /* Ajuste para mobile */
    @media (max-width: 720px){
      #legend-container{ width: 200px; }
      .topbar{ padding: 8px 8px 6px; }
      #mapWrap{ height: calc(100vh - 116px); }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="controls">
      <div class="group">
        <div class="label">ðŸ“… Data</div>
        <input id="dataRef" type="date" />
      </div>

      <div class="group">
        <div class="label">ðŸšš Cargas</div>
        <select id="statusCargas">
          <option value="">TODAS</option>
          <option value="OK">OK</option>
          <option value="ALERTA">ALERTA</option>
        </select>
      </div>

      <div class="group">
        <div class="label">ðŸš— VeÃ­culos</div>
        <select id="statusVeiculos">
          <option value="">TODOS</option>
          <option value="OK">OK</option>
          <option value="ALERTA">ALERTA</option>
        </select>
      </div>

      <button class="btn" id="btnAtualizar">Atualizar</button>

      <span class="pill" id="pillInfo">â€”</span>

      <div class="toggles">
        <label class="toggle"><input type="checkbox" id="tgHoteis" checked> HotÃ©is</label>
        <label class="toggle"><input type="checkbox" id="tgEmbarques" checked> Embarques</label>
        <label class="toggle"><input type="checkbox" id="tgCasas" checked> Casas</label>
        <label class="toggle"><input type="checkbox" id="tgVeiculos" checked> VeÃ­culos</label>
        <label class="toggle"><input type="checkbox" id="tgCargas" checked> Cargas</label>
      </div>
    </div>
  </div>

  <div id="mapWrap">
    <div id="map"></div>

    <div id="legend-container">
      <div class="legend-title">
        <span>Legenda</span>
        <span class="pill" id="pillStatus">â€”</span>
      </div>

      <div class="legend-row"><span class="dot hotel"></span> Hotel</div>
      <div class="legend-row"><span class="dot emb"></span> Embarque</div>
      <div class="legend-row"><span class="dot casa"></span> Casa</div>
      <div class="legend-row"><span class="dot veic"></span> VeÃ­culo parado</div>
      <div class="legend-row"><span class="dot carga"></span> Carga (grupo)</div>
      <hr style="border:none;border-top:1px solid var(--border);margin:10px 0;">
      <div class="legend-row"><span class="dot ok"></span> Status OK</div>
      <div class="legend-row"><span class="dot alert"></span> Status ALERTA</div>

      <div class="legend-small">
        Base: OSM / SatÃ©lite / Terreno (canto superior esquerdo do mapa).
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const WORKER_BASE = "https://irregularidadesmapa.tecnologia-f0c.workers.dev"; // <-- seu worker
const API = {
  ping:            `${WORKER_BASE}/ping`,
  hoteis:          `${WORKER_BASE}/api/hoteis`,
  embarques:       `${WORKER_BASE}/api/pontos_embarque`,
  casas:           `${WORKER_BASE}/api/casas`,
  veiculosParados: `${WORKER_BASE}/api/veiculos_parados`,
  cargasAgrupadas: `${WORKER_BASE}/api/cargas_agrupadas`
};

// Brasil (aprox)
const BR_CENTER = [-14.7, -52.0];
const BR_ZOOM   = 4;

/** =========================
 *  MAP INIT (Leaflet)
 *  ========================= */
const map = L.map("map", { zoomControl: true }).setView(BR_CENTER, BR_ZOOM);

// Bases
const baseOSM = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap"
});

const baseSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19, attribution: "Tiles &copy; Esri" }
);

const baseTerrain = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19, attribution: "Tiles &copy; Esri" }
);

baseOSM.addTo(map);

// Overlays (camadas)
const layerHoteis    = L.layerGroup();
const layerEmbarques = L.layerGroup();
const layerCasas     = L.layerGroup();
const layerVeiculos  = L.layerGroup();

// Cargas com cluster
const layerCargasCluster = L.markerClusterGroup({
  showCoverageOnHover: false,
  maxClusterRadius: 55
});

// Controle de camadas (base + overlays)
L.control.layers(
  {
    "Mapa (OSM)": baseOSM,
    "SatÃ©lite (Esri)": baseSat,
    "Terreno (Esri)": baseTerrain
  },
  {
    "HotÃ©is": layerHoteis,
    "Embarques": layerEmbarques,
    "Casas": layerCasas,
    "VeÃ­culos": layerVeiculos,
    "Cargas": layerCargasCluster
  },
  { collapsed: true }
).addTo(map);

// coloca overlays por padrÃ£o
layerHoteis.addTo(map);
layerEmbarques.addTo(map);
layerCasas.addTo(map);
layerVeiculos.addTo(map);
layerCargasCluster.addTo(map);

/** =========================
 *  UI helpers
 *  ========================= */
const $ = (id) => document.getElementById(id);

function setPill(el, text, cls){
  el.className = "pill";
  if (cls) el.classList.add(cls);
  el.textContent = text;
}

function isoToDMY(iso){
  // "2026-01-22" -> "22/01/2026"
  if (!iso) return "";
  const [y,m,d] = iso.split("-");
  if (!y || !m || !d) return "";
  return `${d}/${m}/${y}`;
}

/** =========================
 *  Fetch helpers
 *  ========================= */
async function apiGet(url){
  const r = await fetch(url, { method: "GET" });
  const j = await r.json().catch(() => null);
  if (!j || j.ok !== true) throw new Error(`GET falhou: ${url}`);
  return j.data ?? j;
}

async function apiPost(url, body){
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body || {})
  });
  const j = await r.json().catch(() => null);
  if (!j || j.ok !== true) throw new Error(`POST falhou: ${url}`);
  return j.data ?? j;
}

/** =========================
 *  Markers styles
 *  ========================= */
function circle(lat, lng, options){
  return L.circleMarker([lat, lng], {
    radius: options.radius ?? 6,
    weight: 2,
    opacity: 1,
    fillOpacity: 0.85,
    color: options.color ?? "#111827",
    fillColor: options.fillColor ?? options.color ?? "#111827"
  });
}

function statusColor(status){
  const s = String(status || "").toUpperCase();
  if (s === "ALERTA") return "#ef4444";
  if (s === "OK") return "#16a34a";
  return "#2563eb";
}

/** =========================
 *  Laudos: vocÃª pediu CONTAGEM
 *  ========================= */
function contarLaudos(laudosStr){
  const raw = String(laudosStr || "").trim();
  if (!raw) return 0;

  // aceita "123, 456, 789" ou "123;456" ou "123 | 456"
  const parts = raw
    .split(/[,\;\|\n]+/g)
    .map(s => s.trim())
    .filter(Boolean);

  // remove duplicados
  return new Set(parts).size;
}

/** =========================
 *  Render functions
 *  ========================= */
function clearLayers(){
  layerHoteis.clearLayers();
  layerEmbarques.clearLayers();
  layerCasas.clearLayers();
  layerVeiculos.clearLayers();
  layerCargasCluster.clearLayers();
}

function renderHoteis(list){
  (list || []).forEach(h => {
    const m = circle(h.lat, h.lng, { color: "#14b8a6", radius: 7 });
    m.bindPopup(
      `<b>Hotel</b><br>` +
      `${escapeHtml(h.nome || "")}<br>` +
      `<small>Lat/Lng: ${h.lat.toFixed(6)}, ${h.lng.toFixed(6)}</small>`
    );
    layerHoteis.addLayer(m);
  });
}

function renderEmbarques(list){
  (list || []).forEach(p => {
    const m = circle(p.lat, p.lng, { color: "#111827", radius: 6 });
    m.bindPopup(
      `<b>Embarque</b><br>` +
      `${escapeHtml(p.nome || "")}` +
      (p.cidade || p.uf ? `<br><small>${escapeHtml((p.cidade||"") + (p.uf?(" - "+p.uf):""))}</small>` : "") +
      `<br><small>Lat/Lng: ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}</small>`
    );
    layerEmbarques.addLayer(m);
  });
}

function renderCasas(list){
  (list || []).forEach(c => {
    const nm = c.nome || c.cpf || "Casa";
    const m = circle(c.lat, c.lng, { color: "#8b5cf6", radius: 6 });
    m.bindPopup(
      `<b>Casa</b><br>` +
      `${escapeHtml(nm)}<br>` +
      `<small>Lat/Lng: ${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}</small>`
    );
    layerCasas.addLayer(m);
  });
}

function renderVeiculos(list){
  (list || []).forEach(v => {
    const col = statusColor(v.status);
    const m = circle(v.lat, v.lng, { color: col, radius: 7 });
    m.bindPopup(
      `<b>VeÃ­culo parado</b><br>` +
      `<b>Status:</b> <span style="color:${col};font-weight:700">${escapeHtml(v.status||"")}</span><br>` +
      `<b>VeÃ­culo:</b> ${escapeHtml(v.veiculo||"")}<br>` +
      `<b>Motorista:</b> ${escapeHtml(v.motorista||"")}<br>` +
      `<b>Parado:</b> ${Number(v.parado_horas||0).toFixed(2)}h (${Number(v.parado_minutos||0)} min)<br>` +
      `<b>Ref:</b> ${escapeHtml(v.ref_tipo||"")} â€“ ${escapeHtml(v.ref_nome||"")} (${escapeHtml(String(v.dist_km||""))} km)<br>` +
      `<b>Janela:</b> ${escapeHtml(v.dt_prev||"")} â†’ ${escapeHtml(v.dt_now||"")}<br>` +
      `<small>Lat/Lng: ${v.lat.toFixed(6)}, ${v.lng.toFixed(6)}</small>`
    );
    layerVeiculos.addLayer(m);
  });
}

function renderCargas(list){
  (list || []).forEach(c => {
    const col = statusColor(c.status);
    const qtdLaudos = contarLaudos(c.laudos);

    const m = circle(c.lat, c.lng, { color: col, radius: 7 });
    m.bindPopup(
      `<b>Carga (Grupo)</b><br>` +
      `<b>Status:</b> <span style="color:${col};font-weight:700">${escapeHtml(c.status||"")}</span><br>` +
      `<b>Classificador:</b> ${escapeHtml(c.classificador||"")}<br>` +
      `<b>Tons:</b> ${Number(c.tons||0).toFixed(2)}<br>` +
      `<b>Laudos (qtd):</b> ${qtdLaudos}<br>` +   <!-- âœ… AQUI: CONTAGEM, nÃ£o texto -->
      `<b>Embarque:</b> ${escapeHtml(c.embarque||"")}<br>` +
      `<b>Dist. Embarque:</b> ${Number(c.dist_embarque_km||0).toFixed(2)} km<br>` +
      `<b>Dist. Casa:</b> ${Number(c.dist_casa_km||0).toFixed(2)} km<br>` +
      `<b>Dist. Hotel:</b> ${Number(c.dist_hotel_km||0).toFixed(2)} km<br>` +
      `<b>Hora:</b> ${escapeHtml(c.hora||"")}<br>` +
      `<small>Lat/Lng: ${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}</small>`
    );

    layerCargasCluster.addLayer(m);
  });
}

function fitAllVisible(){
  const groups = [];
  if (map.hasLayer(layerHoteis) && layerHoteis.getLayers().length) groups.push(layerHoteis);
  if (map.hasLayer(layerEmbarques) && layerEmbarques.getLayers().length) groups.push(layerEmbarques);
  if (map.hasLayer(layerCasas) && layerCasas.getLayers().length) groups.push(layerCasas);
  if (map.hasLayer(layerVeiculos) && layerVeiculos.getLayers().length) groups.push(layerVeiculos);
  if (map.hasLayer(layerCargasCluster) && layerCargasCluster.getLayers().length) groups.push(layerCargasCluster);

  if (!groups.length) return;

  const fg = L.featureGroup(groups);
  try{
    map.fitBounds(fg.getBounds().pad(0.15));
  }catch(_){}
}

/** =========================
 *  Escape HTML
 *  ========================= */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** =========================
 *  Sync toggles (camadas)
 *  ========================= */
function syncToggles(){
  const tg = {
    h: $("tgHoteis").checked,
    e: $("tgEmbarques").checked,
    c: $("tgCasas").checked,
    v: $("tgVeiculos").checked,
    g: $("tgCargas").checked
  };

  toggleLayer(layerHoteis, tg.h);
  toggleLayer(layerEmbarques, tg.e);
  toggleLayer(layerCasas, tg.c);
  toggleLayer(layerVeiculos, tg.v);
  toggleLayer(layerCargasCluster, tg.g);
}

function toggleLayer(layer, on){
  if (on){
    if (!map.hasLayer(layer)) map.addLayer(layer);
  }else{
    if (map.hasLayer(layer)) map.removeLayer(layer);
  }
}

/** =========================
 *  LOAD ALL
 *  ========================= */
async function carregarTudo(){
  const btn = $("btnAtualizar");
  btn.disabled = true;
  btn.textContent = "Carregando...";

  setPill($("pillStatus"), "Atualizando...", "warnpill");
  setPill($("pillInfo"), "â€”");

  try{
    syncToggles();

    const dataISO = $("dataRef").value;
    const dataDMY = isoToDMY(dataISO);

    const filtro = {
      data: dataDMY, // backend espera dd/MM/yyyy
      statusCargas: $("statusCargas").value,
      statusVeiculos: $("statusVeiculos").value
    };

    // limpa primeiro
    clearLayers();

    // busca paralelo
    const [
      hoteis,
      embarques,
      casas,
      veiculos,
      cargas
    ] = await Promise.all([
      apiGet(API.hoteis),
      apiGet(API.embarques),
      apiGet(API.casas),
      apiPost(API.veiculosParados, { data: filtro.data, statusVeiculos: filtro.statusVeiculos }),
      apiPost(API.cargasAgrupadas, { data: filtro.data, statusCargas: filtro.statusCargas })
    ]);

    // render
    renderHoteis(hoteis);
    renderEmbarques(embarques);
    renderCasas(casas);
    renderVeiculos(veiculos);
    renderCargas(cargas);

    // aplica toggles novamente (caso usuÃ¡rio desmarcou)
    syncToggles();

    // info
    const nH = (hoteis||[]).length;
    const nE = (embarques||[]).length;
    const nC = (casas||[]).length;
    const nV = (veiculos||[]).length;
    const nG = (cargas||[]).length;

    setPill($("pillInfo"), `HotÃ©is: ${nH} | Embarques: ${nE} | Casas: ${nC} | VeÃ­culos: ${nV} | Cargas: ${nG}`);
    setPill($("pillStatus"), "OK", "okpill");

    // se tiver algo, ajusta zoom
    fitAllVisible();

    // Se cargas vier vazio, mostra aviso direto (pra nÃ£o â€œsumirâ€ sem explicar)
    if (!nG){
      setPill($("pillStatus"), "Cargas: 0", "warnpill");
    }

  }catch(err){
    console.error(err);
    setPill($("pillStatus"), "Erro", "badpill");
    setPill($("pillInfo"), String(err && err.message ? err.message : err), "badpill");
  }finally{
    btn.disabled = false;
    btn.textContent = "Atualizar";
  }
}

/** =========================
 *  Events
 *  ========================= */
$("btnAtualizar").addEventListener("click", carregarTudo);

["tgHoteis","tgEmbarques","tgCasas","tgVeiculos","tgCargas"].forEach(id=>{
  $(id).addEventListener("change", () => {
    syncToggles();
    // nÃ£o precisa recarregar, sÃ³ alterna visibilidade
  });
});

["statusCargas","statusVeiculos","dataRef"].forEach(id=>{
  $(id).addEventListener("change", () => {
    // troca filtro e recarrega
    carregarTudo();
  });
});

/** =========================
 *  init default date
 *  ========================= */
(function init(){
  // seta hoje (local) no input date
  const now = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  const iso = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
  $("dataRef").value = iso;

  // primeira carga
  carregarTudo();
})();
</script>
</body>
</html>
